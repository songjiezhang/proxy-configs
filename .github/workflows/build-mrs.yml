name: Build direct.mrs from direct.list

on:
  push:
    paths:
      - "rules/direct.list"   # 只有 direct.list 修改时触发
  workflow_dispatch:          # 允许手动在 Actions 页面点按钮触发
  
permissions:
  contents: write   # 让 github-actions[bot] 可以 push
  
jobs:
  build-mrs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download mihomo
        run: |
          # 可以按需要换版本号
          MIHOMO_VERSION="v1.19.17"
          MIHOMO_FILE="mihomo-linux-amd64-${MIHOMO_VERSION}.gz"

          # 下载 gzip 压缩好的二进制
          curl -L "https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/${MIHOMO_FILE}" -o "${MIHOMO_FILE}"

          # 解压并重命名为 mihomo
          gunzip "${MIHOMO_FILE}"
          mv "mihomo-linux-amd64-${MIHOMO_VERSION}" mihomo

          # 加执行权限，顺便看一眼文件信息
          chmod +x mihomo
          ./mihomo -v || true

      - name: Normalize direct.list to mihomo format
        run: |
          cd rules
          awk -F',' '
            /^[[:space:]]*#/ { next }          # 跳过注释
            NF == 0 { next }                   # 跳过空行
            $1 ~ /DOMAIN-SUFFIX/ {
              gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2);  # 去掉空格
              print "+." $2
            }
          ' direct.list > direct_mihomo.list

          echo "Normalized rules:"
          cat direct_mihomo.list

      - name: Convert normalized list to direct.mrs
        run: |
          cd rules
          ../mihomo convert-ruleset domain text direct_mihomo.list direct.mrs
          ls -lh direct.*

      - name: Commit and push direct.mrs
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update direct.mrs from direct.list"
          file_pattern: "rules/direct.mrs"
